apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kubox-virtual-service
  namespace: default
spec:
  hosts:
  - "*"
  gateways:
  - kubox-gateway
  http:
  # User Service (인증) - 최우선
  - match:
    - uri:
        prefix: /api/auth
    - uri:
        prefix: /api/users
    route:
    - destination:
        host: user-svc.default.svc.cluster.local
        port:
          number: 8080
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
    
  # Product Service
  - match:
    - uri:
        prefix: /api/products
    route:
    - destination:
        host: product-svc.default.svc.cluster.local
        port:
          number: 8081
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    
  # Cart Service
  - match:
    - uri:
        prefix: /api/cart
    route:
    - destination:
        host: cart-svc.default.svc.cluster.local
        port:
          number: 8084
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    
  # Order Service
  - match:
    - uri:
        prefix: /api/orders
    route:
    - destination:
        host: order-svc.default.svc.cluster.local
        port:
          number: 8082
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
    
  # Payment Service
  - match:
    - uri:
        prefix: /api/payment
    - uri:
        prefix: /api/payments
    route:
    - destination:
        host: payment-svc.default.svc.cluster.local
        port:
          number: 8083
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
      retryOn: 5xx,reset,connect-failure,refused-stream
  
  # 헬스체크 및 기본 라우팅
  - match:
    - uri:
        prefix: /actuator/health
    - uri:
        exact: /
    route:
    - destination:
        host: user-svc.default.svc.cluster.local
        port:
          number: 8080
    timeout: 10s
